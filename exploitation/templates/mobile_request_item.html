{% extends 'mobile_base.html' %}
{% load bootstrap4 personal_tags exploitation_request_tags %}

{% block addjs %}
    <script>
        var findMeButton = $('.find-me');
            // Check if the browser has support for the Geolocation API
            if (!navigator.geolocation) {
                findMeButton.addClass("disabled");
                $('.no-browser-support').addClass("visible");
                alert('Данные не доступны');
            } else {
                findMeButton.on('click', function(e) {
                    e.preventDefault();
                    navigator.geolocation.getCurrentPosition(function(position) {

                    // Get the coordinates of the current possition.
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    alert(lat+' '+lng);
    {#                $('.latitude').text(lat.toFixed(3));#}
    {#                $('.longitude').text(lng.toFixed(3));#}
    {#                $('.coordinates').addClass('visible');#}

                  // Create a new map and place a marker at the device location.
    {#              var map = new GMaps({#}
    {#                el: '#map',#}
    {#                lat: lat,#}
    {#                lng: lng#}
    {#              });#}

    {#              map.addMarker({#}
    {#                lat: lat,#}
    {#                lng: lng#}
    {#              });#}

                });

              });

            }
{% comment %}        // Кладем в переменную адрес <div> для вывода текста
        var posText = document.getElementById("positionText");
        function getLocation() {
            if (navigator.geolocation) {
                // Если пользователь разрешил, определяем его местоположение и обрабатываем полученное значение с помощью функции ShowPosition
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                // Если нет, выводим сообщение об ошибке
                posText.innerHTML = "Этот браузер не может определять местоположение";
            }
        }
        function showPosition(position) {
            // Выводим широту и долготу на страницу
            posText.innerHTML = "Широта: " + position.coords.latitude +
            "<br>Долгота: " + position.coords.longitude;
        }{% endcomment %}
    </script>
{% endblock %}

{% block page_title %}Заявка{% endblock %}
{% block section_active %}
    {% if request_data %}
        №{{ request_data.id }}
    {% else %}
        новая
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
{% comment %}        <div class="alert alert-info" role="alert">
            Внимание! При заполнении формы желательно включить систему GPS.
        </div>{% endcomment %}
        {% if request_data.Required_act %}
            <div class="alert alert-danger" role="alert">
                Необходимо выписать акт выполненных работ
            </div>
        {% endif %}
        <form action="{% if request_data %}{% url 'exploitation:change_eproposals_engineer' request_data.id %}{% else %}{% url 'exploitation:change_eproposals_engineer' %}{% endif %}" method="post" class="form">
            {% csrf_token %}
            {% bootstrap_form_errors form %}
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Сервисная компания" label_for="ServiceCompany" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.ServiceCompany layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Объект" label_for="NumObject" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.NumObject layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Адрес" label_for="AddressObject" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.AddressObject layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Наименование" label_for="Client_words" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.Client_words layout='inline' %}
                    </div>
                </div>
            </div>
            <div>
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Неисправность" label_for="FaultAppearance" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.FaultAppearance layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Срок исполнения" label_for="DateTime_schedule" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.DateTime_schedule layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Статус" label_for="Status" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.Status layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Дата выполнения" label_for="DateTime_work" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.DateTime_work layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Описание выполнения" label_for="DescriptionWorks" %}
                    </div>
                    <div class="col-md-7 col-sm-12">
                        {% bootstrap_field form.DescriptionWorks layout='inline' %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-5 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_label "Выписан акт" label_for="Written_act" %}
                    </div>
                    <div class="col-md-7 col-sm-12" style="padding-top: 5px;">
                        {% bootstrap_field form.Written_act %}
                    </div>
                </div>
            </div>
{#            <div class="posText"></div>#}
{% comment %}            <div class="form-group">
                <div class="row">
                    <div class="col-5" style="padding-top: 5px;">
                        {% bootstrap_label "Координаты" label_for="latitude" %}
                    </div>
                    <div class="col-7" style="padding-top: 5px;">
                        {% bootstrap_field form.latitude layout='inline' %}
                        {% bootstrap_field form.longitude  layout='inline' %}
                        <button type="button" class="find-me btn btn-info btn-block">Найти меня</button>
                    </div>
                </div>
            </div>{% endcomment %}
            <hr/>
            <div class="form-group">
                {% bootstrap_button "Сохранить" button_type="submit" button_class="btn-primary btn-lg"  %}
            </div>
        </form>
        {% if history_object %}
            <hr/>
            <p>
                <a class="btn btn-primary" data-toggle="collapse" href="#history" role="link" aria-expanded="false" aria-controls="history">Показать историю по объекту</a>
            </p>
            <div class="row">
                <div class="col">
                    <div class="collapse multi-collapse" id="history">
                        <div class="card card-body">
                            <ul class="list-group list-group-flush">
                                {% for item in history_object %}
                                    <li class="list-group-item">
                                        <div class="row">
                                            <div class="col-3">
                                                <strong>№{{ item.id }}</strong><br/>
                                                Объект: {{ item.NumObject }}
                                            </div>
                                            <div class="col-2">
                                                <em>{{ item.DateTime_work|date:'d.m' }}</em>
                                                <em>{{ item.DateTime_work|date:'Y' }}</em>
                                            </div>
                                            <div class="col-7">
                                                {{ item.DescriptionWorks }}<br>
                                                <code>Исполнители: {% get_fullname_coworks item.id %}</code>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}